## 两段事务提交

两端事务是常见的处理分布式事务处理手法. 两段事务提交的参与者有两个: 协调者和参与者。协调者只有一个，参与者有多个。

整个过程分成两个阶段，发起阶段和提交阶段。发起阶段由发起者向所有的参与者发起申请。参与者接到请求后判断自己是否可以参与事务，然后回复参与者是commit还是abort.

参与者状态流转: init -> ready.
协调者状态流转: init -> pre_commit.

协调者等待所有的参与者都回复后发起投票阶段。如果所有的参与者回复commit，则协调者向参与者发送commit命令。如果有一个发送abort则发送abort命令。

参与者状态流转: ready -> commit
协调者状态流转: pre_commit -> commit

以上说的是正常的状态流转. 还存在一些问题:
1. 性能问题. 整个阶段都是同步操作, 第一阶段过后, 资源都处于被锁的状态. 如果任何一个参与者发生网络超时则资源被锁的时间会更长. 
2. 网络问题. 两个阶段中各个参与者之间都是通过网络进行通信. 网络存在不稳定性, 这也会导致一些问题. 而且两个阶段都会出现网络问题:
- 第一个阶段. 参与者没有收到协调者指令, 或者协调者没有收到参与者的回复. 这种情况下这个事务将会取消.
- 第二个阶段, 参与者没有收到协调者发过来的指令, 则这个参与者将会处于不知所从的阶段. 这时参与者可以向其他节点进行状态查询, 如果其他节点是commit状态, 则自己也提交事务, 如果是fail状态, 则自己也回滚事务. 如果这个节点也处于未知状态, 则可以查询下一个节点.

## 三段事务提交

//TODO
三段事物提交核心理念是在询问阶段不锁定资源, 除非所有的人都同意了才开始锁定资源.

## 基于队列的分布式事务



## 幂等+重试