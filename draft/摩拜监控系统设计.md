## 整体架构图



## 遇到的问题
当系统流量上升到亿级的时候，会面临这各种不同的问题。比如，有的问题再流量小的时候不是问题，但是如果在大流量系统里，小问题的影响会累积，造成问题。

1. 消费者问题。
程序内部使用了线程池做数据库相关的查询，在数据量小的时候运行的没有任何问题。后来数据量增加，服务一段时间之后开始出现OOM。因为，内部使用线程池做了异步处理，但是生产者生产的速度和消费者处理速度远远不成比例，导致线程池队列一致积压任务，最终引发了OOM。

2. 水平扩展问题。
客户端和服务端都是长连接保持，想通过nginx等负载均衡器水平扩展服务是行不通的。所有的已有链接不会切到新服务，这是和http差别很大的。

解决方案1，硬负载改为软负载。引入注册中心，客户端定时从注册中心拉取可用服务列表，并更新本地的连接池。在发送请求的时候，可采用round-robin或者random的方式从连接池选取链接。

解决方案2，加上服务评分的机制，服务可根据自己过去一段时间处理的请求和自己的处理能力求一个负载值，向注册中心注册的时候可以附带上这个值，客户端在选取链接的算法中，会选取负载最小的服务。

解决方案3，back-pressure机制。

3. 客户端问题。
客户端遇到的问题主要是线程使用上一些没有注意到的点：
- task有异常导致ScheduledExecutorService任务终止。



## 高可用

高可用最简单的衡量指标是几个9，代表的是服务的可用时间。可以从几个维度去提高软件的高可用：
 - 软件质量：上线的程序是不是有bug。
 - 运维水平：软件发布是不是安全可靠，如果发现问题，最快可多长时间回滚。
 - 外部因素：多区部署。
 - 可扩展性：比如负载高是可以以添加机器。
 - 服务降级：在高负载下服务的降级回馈措施。


## 策略处理模块内存的优化

## JVM优化

## Netty/gRPC优化

## ES存储和Kafka优化




